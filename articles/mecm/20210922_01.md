---
title: [運用改善] 重複GUIDの対処について
date: 2021-09-22
tags:
  - MECM
---

みなさま、こんにちは。Configuration Manager サポート チームです。  

本日は、お客様をサポートする中、我々が頻繁に遭遇する「重複 GUID 問題」についてご案内させて頂きます。
是非、運用されている Configuration Manager (CM) について定期的にご確認いただき、System Health を良い状態に保つ一助にして頂きたく存じます。

## 重複 GUID 問題 とは

CM がクライアントの同定のために引き当てる、GUID "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" の形式の番号が、複数の端末にて重複してしまう問題です。

## 何が問題なの?

CM がクライアントの同定を正しく行えなくなってしまうので、下記のような事象が発生します。
CM のほぼ全ての機能が正しく利用出来なくなってしまいます。

- 意図しない端末に対して、アプリケーション、パッケージ、更新プログラム、タスクシーケンスの配布を行ってしまう。
- 回収したインベントリ情報が正しい端末に紐付かない (収集したインベントリ情報を信頼できなくなってしまう)

## どうして問題が発生するの？

CM はクライアントが CM の管理ポイントに初めて接続した際に GUID を生成し、クライアント側に伝えます。そのクライアント側に伝えられた GUID は %windir%\SMSCFG.ini に保管されます。この一連の流れにより CM サーバーにクライアント情報が登録されます。クライアントは、この SMSCFG.ini に記載の GUID を利用して CM とのやりとりを行います。  
  
ということは、この登録作業が終わってしまっている CM のクライアントのデータを複製すると、複製元のクライアントと、複製先のクライアントにて、SMSCFG.ini もまた複製されてしまうわけですから、GUID も同じものを使ってしまいます。本当は違うクライアントでも、CM サーバーから見ると、GUID が同じなので、同じ端末と見なしてしまいます。

## どのような時に問題が発生するの？

CM への登録が終わってしまっている CM クライアントを複製した場合に発生します。
つまり、以下のような場合です。

- CM 登録済み OS のイメージをキャプチャして、キッティングの際のベースイメージとした場合。
- CM 登録済みの仮想マシンを仮想マシンテンプレートとした場合。
- CM 登録済みの仮想マシンをクローンした場合。
- CM 登録済みのバックアップを他のマシンにリストアし、並行稼働した場合。

特にVDIをご利用されている環境で多く発生している印象です。

## どのように問題を察知すれば良いの?

CM のデータベーステーブル System_HIST には CMが管理している端末についてホスト名が変わった際の履歴が残っております。このテーブルにて、MachineID と SMSID が同じなのに、ホスト名が頻繁に切り替わっているものがあった場合、GUID 重複が発生している可能性が非常に高いと判断できます。なお、本テーブルにて MachineID と SMSID が同じレコードの中で、TimeKey が最も古い端末が複製元となっている可能性が高いため、調査の参考にして頂ければと存じます。 

CM 管理者の方には定期的に本テーブル内容の確認を定期運用作業に組み込むことをお勧めいたします。

## どのように問題を解決すれば良いの？

環境の複製先と、複製元の端末にて以下の対処を実施ください。

### 複製先端末

以下の手順で対処を実行ください。

1. CCMExecサービスを停止します。
2. 以下のPowershellスクリプトを実行します。
```powershell
Get-WMIObject -Namespace root\CCMVDI -Class CCM_VDI_Identity_Store_Configuration -Filter “Name<>’RDV’” | Remove-WMIObject
Remove-Item -Path HKLM:\Software\Microsoft\SystemCertificates\SMS\Certificates -Recurse -Force
Remove-Item -Path C:\Windows\SMSCFG.ini -Force -ErrorAction SilentlyContinue
```
3. CCMExecサービスを起動します。

#### 複製先端末が複数の場合の対処

1. 重複しているGUIDを持つ端末を集めたデバイスコレクションを作成します。下記のWQLクエリをご利用ください。
```sql
select *  from  SMS_R_System where SMS_R_System.SMSUniqueIdentifier = '[重複GUIDを起こしているGUID]'
```
2. 上記コレクションに対して単体対処の時に利用したPowershellをパッケージで配布します。パッケージ配布の際のコマンドは以下を指定ください。
```console
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File XXXX.ps1
```
3. パッケージを配布されたクライアントは再起動され次第、新しい GUID を順次取得します。配布対象のコレクションに所属するクライアント数が少なくなっていけば事象解消し始めていることになります。

### 複製元端末 (マスターイメージ)

1. 下記ブログにてご案内している手順でCM クライアントを完全アンインストールください。
  - https://jpmem.github.io/blog/mecm/20190327_01/
2. (Citrix VDI端末のマスターイメージの場合) Powershellを管理者権限で開き、以下を実行ください。
```powershell
Get-WmiObject -Namespace root\CCMVDI -Class CCM_VDI_Identity_Store_Configuration -Filter "Name='Citrix'" | Remove-WmiObject
```
3. CM コンソールから、重複していた GUID を持つデバイスのレコードを削除します。
4. 以下のマスターイメージ用の CM クライアント インストール手順を実施します。
5. マスターイメージを取得します。

#### マスターイメージ用 CM クライアント インストール手順
##### 事前準備
- SMS Agent Host サービスの停止とスタート アップの種類の変更
[管理ツール] - [サービス] を起動し、SMS Agent Host サービスを停止します。また、マスター イメージ採取前に自動でサービスが起動しないように、右クリックしてプロパティを開き、スタートアップの種類を [手動] に変更します。

また、タスクスケジューラを開き [Microsoft] - [Configuration Manager] にある [Configuration Manager Health Evaluation] タスクを右クリックして [無効] にします。
これによって、SMS Agent Host サービスが自動で起動しないようになります。


##### 手順
1. 以下の手順にて、サイト コードが "未割り当て" の状態でエージェントのセットアップを行います。

   1. サイト サーバーより、SCCM インストール フォルダー 配下に存在する Client フォルダーをコピーし保存します。インストール フォルダーの初期設定は以下になります。
     ```
      \Program Files\Microsoft Configuration Manager\Client
     ```
   2. 参照コンピューターにローカル管理者権限をもつユーザーでログインします。
   3.  項番 1) でコピーした Client フォルダーを、クライアント上の任意のフォルダーに格納します。
   4. サイト サーバーと通信できないようにするため、ネットワーク ケーブルを抜きます。
   5. [管理者として実行] にてコマンド プロンプトを開き、cd コマンドでクライアントに格納した Client フォルダーに移動します。
   6. 以下のコマンドを実行します。
   ```console
     ccmsetup.exe
   ```
     ※オプションなしで ccmsetup.exe を実行することにより、"未割り当て" の状態でエージェントがセットアップされます。
   7. タスクマネージャーを起動して [プロセス] タブにて ccmsetup.exe が表示されなくなるまで待ちます。
   8. [コントロール パネル] -> [システムとセキュリティ] -> [Configuration Manager] を開き、以下のようにサイト コードが "未割り当て" の状態であることを確認します。
      - [コンポーネント] タブ : 「CCM 通知エージェント」以外のすべての項目が「インストール済み」であることを確認します。
      - ※ 「CCM 通知エージェント」は「無効」になります。
      - [サイト] タブ : 「現在の割り当てサイト コード」が空欄であることを確認します。

2. SMS Agent Host サービスの停止とスタート アップの種類の変更  
[管理ツール] - [サービス] を起動し、SMS Agent Host サービスを停止します。また、マスター イメージ採取前に自動でサービスが起動しないように、右クリックしてプロパティを開き、スタートアップの種類を [手動] に変更します。

3. SCCM で使用する自己署名証明書を削除する  
以下の手順で自己署名証明書を削除します。  
   1. コマンド プロンプトを開き、"mmc" を入力して実行します。
   2. [ファイル] - [スナップインの追加と削除] をクリックします。
   3. 左ペインから [証明書] をクリックして [追加] ボタンをクリックします。
   4. "コンピューター アカウント" にチェックを入れて、[次へ] をクリックします。
   5. "ローカル コンピューター" にチェックし、[完了] をクリックします。
   6. 右ペインに "証明書（ローカル コンピューター）" が追加されていることを確認し [OK] をクリックします。
   7. 左ペインにて、[証明書] - [SMS] - [証明書] を選択します。
   8. 中央ペインに表示された 2 つの "SMS" 証明書に対して、それぞれ右クリックして [削除] を選択します。
     「選択された証明書を永久的に削除しますか?」というメッセージが表示されますので、[はい] を選択します。
   9. [ファイル] - [終了] をクリックします。「コンソールの設定を コンソール1 に保存しますか?」というメッセージが表示されますので、[いいえ] を選択して、mmc を終了します。

4. SCCM 独自の信頼キーと管理ポイントの証明書を削除する

エージェントのインストール完了後に、もしネットワークに接続して、SCCM サーバー(管理ポイント サーバー) との通信が可能となった場合、参照コンピューターが、SCCM で使用する信頼キーと管理ポイントの証明書を WMI の中に保持した状態となる可能性があります。

この場合、参照コンピューターに保存されている信頼キーや管理ポイントの証明書を削除する必要があります。wbemtest より、WMI 名前空間 "root\ccm\locationservices" に接続できない場合は、SCCM サーバーと一度も接続がされていないため、問題ありません。接続できる場合は、情報を削除するため、以下の手順を実施してください。

以下の内容をサンプルとしてスクリプトを作成し、vbs ファイルとして保存します。本スクリプトを実行することで、信頼キーや管理ポイントの証明書も削除されます。

```vb
dim oSMSClient
dim objLocator
dim objService

set objLocator = CreateObject("WbemScripting.SWbemLocator")
set objService = objLocator.ConnectServer(".", "root\ccm\locationservices")
set keys = objService.ExecQuery("select * from TrustedRootKey")

for each k in keys
k.delete_()
next
```

スクリプトを作成した後、参照コンピューターでコマンド プロンプトを "管理者として実行" にて起動し、
以下のコマンドを実行します。

※) C:\Temp にスクリプト DeleteTRK.vbs を保存した場合
```console
cd C:\Temp
cscript DeleteTRK.vbs
```
スクリプト実行完了後、以下の手順で、正常に信頼キーや証明書が削除されたことを確認します。

   1. コマンド プロンプトを "管理者として実行" にて起動して wbemtest を実行し、"root\ccm\locationservices" 名前空間に接続します。
   2. 「スーパークラス名の入力」はブランクのまま、「クラスの列挙」を "再帰" を有効にして実行します。
   3. 一覧から "TrustedRootKey" を選択し、ダブルクリックして開きます。
   4.  開いた画面で「インスタンス」をクリックします。
   5.  インスタンスが存在しないことを確認します。

5. SMSSLP または DNSSUFFIX のレジストリ値を設定する (任意)
ccmsetup.exe をオプションなしでインストールした場合、AD スキーマが拡張されており、サイト割り当ての境界グループが設定されていれば、次回起動後にサイトが自動的に割り当てられます。但し、AD スキーマを拡張していない場合やワークグループ端末の場合は、AD スキーマから情報を取得して自動でサイトを割り当てることができませんので、サイト割り当てができるように、SMSSLP または DNSSUFFIX のレジストリ値を設定することをご検討ください。SMSSLP のレジストリ値は ccmsetup.exe に SMSMP オプション、DNSSUFFIX のレジストリ値は、DNSSUFFIX オプションを付加してインストールした場合に、セットされるレジストリ値です。SMSSLP のレジストリ値の設定が必要である場合は、以下のレジストリ値に、割り当てるサイトの管理ポイント サーバーの FQDN 名をセットしてください。(対象端末から、名前解決できる FQDN 名であることが前提です。)

```
キーの場所 : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CCM
値の名前 : SMSSLP
値の種類 : REG_SZ
``` 
```
・DNSSUFFIX
キーの場所 : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CCM\LocationServices
値の名前 : DnsSuffix
値の種類 : REG_SZ
```

6. SMS Agent Host サービスのスタート アップの種類の変更

[管理ツール] - [サービス] を起動し、SMS Agent Host サービスを右クリックしてプロパティを開き、スタートアップの種類を [自動（遅延開始）] に変更します。SMS Agent Host サービスを開始しないように注意してください。
また、タスクスケジューラを開き [Microsoft] - [Configuration Manager] にある [Configuration Manager Health Evaluation] タスクを右クリックして [有効] にします。
SMS Agent Host サービスを手動で開始しないように注意してください。

7. マスターイメージの採取
sysprep /generalize が実行された参照コンピューターをキャプチャして、マスター イメージを採取します。

## どのように問題を予防すれば良いの?

恐れながら基本的に運用による予防をお願い致します。マスターイメージをキャプチャされる際は、CM に登録されないように。また、CMクライアントで管理されている実利用の端末（検証用途ではない）が仮想マシンで
作成されている場合、安易に仮想マシンの複製を行わないようにご対応ください。